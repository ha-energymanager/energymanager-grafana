#!/usr/bin/with-contenv bash
set -euo pipefail

OPTS=/data/options.json
ADMIN_USER=$(jq -r '.admin_user' "$OPTS")
ADMIN_PASSWORD=$(jq -r '.admin_password' "$OPTS")
ALLOW_ANON=$(jq -r '.allow_anonymous' "$OPTS")

# Ask Supervisor for our canonical ingress URL (absolute) and entry (path)
ADDON_INFO_JSON="$(curl -fsS -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" http://supervisor/addons/self/info)"
INGRESS_URL="$(echo "$ADDON_INFO_JSON"   | jq -r '.data.ingress_url   // empty')"
INGRESS_ENTRY="$(echo "$ADDON_INFO_JSON" | jq -r '.data.ingress_entry // empty')"

# Decide the public root URL Grafana should use.
# Prefer absolute ingress_url. Fallback builds a URL using Grafana's templated vars.
if [ -n "$INGRESS_URL" ]; then
  case "$INGRESS_URL" in
    */) export GF_SERVER_ROOT_URL="$INGRESS_URL" ;;
    *)  export GF_SERVER_ROOT_URL="${INGRESS_URL}/" ;;
  esac
else
  # Old supervisors may not provide ingress_url. Build from the path.
  # %(protocol)s/%(domain)s/%(http_port)s are substituted by Grafana at runtime.
  ENTRY="${INGRESS_ENTRY%/}/"
  export GF_SERVER_ROOT_URL="%(protocol)s://%(domain)s:%(http_port)s${ENTRY}"
fi

# Required for subpath/Ingress
export GF_SERVER_SERVE_FROM_SUB_PATH=true
export GF_SECURITY_ALLOW_EMBEDDING=true
export GF_SERVER_ENFORCE_DOMAIN=false

# Persisted paths
export GF_PATHS_DATA=/data/grafana
export GF_PATHS_LOGS=/data/logs
export GF_PATHS_PLUGINS=/data/plugins
export GF_PATHS_PROVISIONING=/etc/grafana/provisioning

# Admin creds
export GF_SECURITY_ADMIN_USER="$ADMIN_USER"
export GF_SECURITY_ADMIN_PASSWORD="$ADMIN_PASSWORD"

# Avoid cookie collisions if user also exposes port 3000 directly
export GF_AUTH_LOGIN_COOKIE_NAME=grafana_ingress

# Anonymous option
if [ "$ALLOW_ANON" = "true" ]; then
  export GF_AUTH_ANONYMOUS_ENABLED=true
  export GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
else
  export GF_AUTH_ANONYMOUS_ENABLED=false
fi

# Ownership & start
if getent passwd grafana >/dev/null 2>&1; then
  chown -R grafana:grafana /data || true
  exec s6-setuidgid grafana grafana-server \
    --homepath=/usr/share/grafana \
    --config=/etc/grafana/grafana.ini \
    --packaging=addon
else
  exec grafana-server \
    --homepath=/usr/share/grafana \
    --config=/etc/grafana/grafana.ini \
    --packaging=addon
fi
