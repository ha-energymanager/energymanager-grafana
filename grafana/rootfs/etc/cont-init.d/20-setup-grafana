#!/usr/bin/with-contenv bash
set -euo pipefail

OPTS=/data/options.json
ADMIN_USER=$(jq -r '.admin_user' "$OPTS")
ADMIN_PASSWORD=$(jq -r '.admin_password' "$OPTS")
ALLOW_ANON=$(jq -r '.allow_anonymous' "$OPTS")

# Core Grafana paths
export GF_PATHS_DATA=/data/grafana
export GF_PATHS_LOGS=/data/logs
export GF_PATHS_PLUGINS=/data/plugins
export GF_PATHS_PROVISIONING=/etc/grafana/provisioning

# Ingress
export GF_SERVER_SERVE_FROM_SUB_PATH=true

# Auth
export GF_SECURITY_ADMIN_USER="$ADMIN_USER"
export GF_SECURITY_ADMIN_PASSWORD="$ADMIN_PASSWORD"

if [ "$ALLOW_ANON" = "true" ]; then
  export GF_AUTH_ANONYMOUS_ENABLED=true
  export GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
else
  export GF_AUTH_ANONYMOUS_ENABLED=false
fi

# Optional plugins
if jq -e '.plugins | length > 0' "$OPTS" >/dev/null 2>&1; then
  while IFS= read -r plug; do
    echo "Installing plugin: $plug"
    grafana-cli --pluginsDir "/data/plugins" plugins install "$plug" || true
  done < <(jq -r '.plugins[]' "$OPTS")
fi

# Copy datasource YAMLs; dashboards are read in-place from /share
/usr/local/bin/prepare-provisioning
